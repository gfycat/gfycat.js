language: node_js

node_js:
  - 6

# Ubuntu 14 Trusty is old, and Travis might stop supporting it at some point,
# so we need to figure out how to get xvfb working on Ubuntu 16 and newer:
# https://docs.travis-ci.com/user/gui-and-headless-browsers/#sts=Using%20xvfb%20to%20Run%20Tests%20That%20Require%20a%20GUI%20#
dist: trusty

before_install:
  - export CHROME_BIN=chromium-browser
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start

before_script:
  - npm install -g gulp-cli

script:
  - npm install
  - npm run build
  - npm run test

deploy:
  - provider: s3
    access_key_id: "$ARTIFACTS_KEY"
    secret_access_key: "$ARTIFACTS_SECRET"
    bucket: "assets.gfycat.com"
    skip_cleanup: true
    local_dir: dist
    acl: public_read
    region: us-west-1
    cache_control: "max-age=86400,public"
    detect_encoding: false
    debug: true
    on:
      branch: master

  - provider: s3
    access_key_id: "$ARTIFACTS_KEY"
    secret_access_key: "$ARTIFACTS_SECRET"
    bucket: "assets.gfycat.com"
    on:
      all_branches: true
    skip_cleanup: true
    local_dir: dist
    upload-dir: "gfycat/$TRAVIS_BUILD_ID"
    acl: public_read
    region: us-west-1
    cache_control: "max-age=946707779,public"
    expires: "Sat Apr 29 2032 13:31:45 GMT+0000"
    detect_encoding: false
    debug: true
